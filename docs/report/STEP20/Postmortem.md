# (가상) 2025/09/11 개발자 오프셋 커밋 누락으로 인한 쿠폰 중복 발급 장애
> [장애 대응의 목표] 장애 대응의 최우선 목표는 문제를 정상화하는 것입니다.

## Summary
선착순 1,000명 한정 쿠폰 이벤트 중 컨슈머 코드에서 오프셋 커밋 로직 누락으로 메시지 재처리 발생. <br/>
MySQL Unique Key 전략으로 실제 중복 발급은 방어되었으나, 대량의 Duplicate Key 에러로 인한 서비스 장애 발생.
<br/>

## Impact
- 중복 발급 시도: 218건
- 실제 초과 발급: 0건
- 고객 불만 접수: 15건

<br/>

## Root Causes
- 개발자 실수: 오프셋 커밋 코드 누락
- 코드 리뷰 미흡

<br/>

## Trigger
1. 애플리케이션 메모리 증가로 자동 재시작
2. 카프카 컨슈머 재연결
3. 커밋되지 않은 메시지 부터 재처리 시작
4. 이미 쿠폰 발급 처리된 메시지 218건 재처리 

<br/>

## Resolution
1. 카프카 컨슈머 일시 중지
2. 수동으로 오프셋 커밋 실행
3. 코드 수정
4. 긴급 배포
5. 서비스 정상화 확인

<br/>

## Detection
1. ELK에서 DuplicateKeyException 로그 폭증
2. 1분간 100건 초과 트리거
3. Slack 알림 발송
4. 담당자 인지 및 대응 시작

<br/>


## Discussion
- 코드 리뷰 프로세스 개선
  - 카프카 관련 체크리스트 오프셋 커밋 검증 추가
  
- 테스트 전략 개선
  - 통합 테스트에서 오프셋 커밋 검증

- 차기 세션에서 카프카 관련 토픽으로 발표

<br/>

## 참고 문서
- 포스트모템 양식: [데브시스터즈의 장애 대응 원칙과 방법](https://tech.devsisters.com/posts/incident-management-principles/)
